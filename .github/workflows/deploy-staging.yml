name: Deploy to Staging

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/rhr

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    # Only deploy if CI passed AND staging secrets are configured
    if: ${{ github.event.workflow_run.conclusion == 'success' && vars.STAGING_ENABLED == 'true' }}

    environment:
      name: staging
      url: https://staging.raptorhr.com

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get commit SHA
        id: sha
        env:
          GITHUB_SHA_FULL: ${{ github.sha }}
        run: echo "short_sha=${GITHUB_SHA_FULL:0:7}" >> $GITHUB_OUTPUT

      - name: Deploy to staging server
        uses: appleboy/ssh-action@master
        env:
          BACKEND_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:sha-${{ steps.sha.outputs.short_sha }}
          FRONTEND_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:sha-${{ steps.sha.outputs.short_sha }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_ACTOR: ${{ github.actor }}
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          envs: BACKEND_IMAGE,FRONTEND_IMAGE,GH_TOKEN,GH_ACTOR
          script: |
            set -e

            # Navigate to deployment directory
            cd /opt/rhr

            # Pull latest code for configs
            git fetch origin main
            git checkout main
            git pull origin main

            # Login to GitHub Container Registry
            echo "${GH_TOKEN}" | docker login ghcr.io -u "${GH_ACTOR}" --password-stdin

            # Set environment variables
            export BACKEND_IMAGE="${BACKEND_IMAGE}"
            export FRONTEND_IMAGE="${FRONTEND_IMAGE}"

            # Pull new images
            docker compose -f docker-compose.prod.yml pull

            # Run database migrations
            docker compose -f docker-compose.prod.yml run --rm backend python manage.py migrate --no-input

            # Restart services with zero downtime
            docker compose -f docker-compose.prod.yml up -d --remove-orphans

            # Wait for services to be healthy
            sleep 30

            # Verify deployment
            curl -f http://localhost/health || exit 1

            # Clean up old images
            docker image prune -f

      - name: Notify deployment success
        if: success()
        env:
          COMMIT_SHA: ${{ github.sha }}
        run: |
          echo "Deployment to staging successful!"
          echo "Commit: ${COMMIT_SHA}"
          echo "Environment: staging"

      - name: Notify deployment failure
        if: failure()
        env:
          COMMIT_SHA: ${{ github.sha }}
        run: |
          echo "Deployment to staging failed!"
          echo "Commit: ${COMMIT_SHA}"
          exit 1

  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Health check via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            # Check API health internally (bypasses Cloudflare)
            curl -f http://localhost/api/v1/health/ || exit 1

            # Check frontend
            curl -f http://localhost/ || exit 1

            echo "Smoke tests passed!"